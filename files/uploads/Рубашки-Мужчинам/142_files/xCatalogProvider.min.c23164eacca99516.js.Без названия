(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
"use strict";!function(){const r=require("./xcatalog/goodsProvider"),e=require("./xcatalog/filtresProvider"),t=require("./xcatalog/advertProvider");let o=function(){function o(){}return o.createGoodsProvider=function(...e){return new r(...e)},o.createFiltresProvider=function(...r){return new e(...r)},o.createAdvertProvider=function(...r){return new t(...r)},o}();window.__spaModuleManager__.register("xCatalogProvider",o)}();

},{"./xcatalog/advertProvider":2,"./xcatalog/filtresProvider":3,"./xcatalog/goodsProvider":4}],2:[function(require,module,exports){
"use strict";function _defineProperties(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,_toPropertyKey(i.key),i)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==typeof t?t:String(t)}function _toPrimitive(e,t){if("object"!=typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var i=r.call(e,t||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}function _inheritsLoose(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}const CatalogAdvertCache=require("./helpers/catalogAdvertCache"),ADVERT_TYPE=Object.freeze({catalog:1,search:2,promo:3});let XCatalogAdvertProvider=function(e){function t(t){var r;return(r=e.call(this)||this).queryDictionary=t,r.cacheHelper=CatalogAdvertCache.getAdvertCache(),r}_inheritsLoose(t,e);var r=t.prototype;return r.update=function(e){this.queryDictionary=e,this._advertType=null},r.loadAdvData=async function(){const{queryDictionary:e}=this;if(!this.advertEnabled)return null;if(!e.searchtext&&!e.menuId&&!e.promoId)return Promise.resolve(null);if(130255===e.menuId||130504===e.menuId)return null;const t=this._getCacheKey(e),r=await this.cacheHelper.getAdvertInfo(t);if(null!=r&&!r.isEmpty)return r;if(null!=r&&r.isEmpty)return null;const i=this._getAdvertUrl(e);try{return await this._loadData(i,t)}catch(e){return null}},r.mixInAdvertGoods=function(e,t,r,i){var n;if(!((null==e?void 0:null===(n=e.advGoods)||void 0===n?void 0:n.length)>0&&this.advertEnabled))return t;let o=parseInt(r.getKey("page"));isNaN(o)&&(o=1);const a=this._getfilteredPagedAdvGoods(e,r,i);if(!a)return t;const s=a[o];return this._mergeAdvertAndCommonGoods(t,s)},r._loadData=function(e,t){return new Promise((r,i)=>{const n=setTimeout(()=>i(null),800);this.$httpClient.fetchBasicJSON(e).then(e=>{var i,o,a,s;clearTimeout(n),this.advertType===ADVERT_TYPE.promo&&(e=this._buildPromoAdvData(e)),(!(null!==(i=e)&&void 0!==i&&null!==(o=i.adverts)&&void 0!==o&&o.length)>0||!(null!==(a=e)&&void 0!==a&&null!==(s=a.pages)&&void 0!==s&&s.length)>0)&&(this.cacheHelper.saveAdvertInfo(t,{isEmpty:!0}),r(null));const d=e.adverts.map(e=>e.id);return 0===d.length&&(this.cacheHelper.saveAdvertInfo(t,{isEmpty:!0}),r(null)),wb.xnm.getGoodsForRecommendAndCatalog(d).then(r=>this.cacheHelper.saveAdvertInfo(t,{advGoods:r,advData:e}).then(()=>Promise.resolve(r))).then(t=>{r({advGoods:t,advData:e})})}).catch(()=>{r(null)})})},r._getAdvertType=function(e){return void 0!==e.searchtext?ADVERT_TYPE.search:e.promoId?ADVERT_TYPE.promo:ADVERT_TYPE.catalog},r._getAdvertUrl=function(e){const t="https://catalog-ads.wildberries.ru/api/v5";switch(this.advertType){case ADVERT_TYPE.search:return`${t}/search?keyword=${e.searchtext.toSafeString()}`;case ADVERT_TYPE.promo:return`https://recom-ads.wildberries.ru/api/v2/promoads?id=${e.promoId}`;default:return`${t}/catalog?menuid=${e.menuId}`}},r._buildPromoAdvData=function(e){if(!e)return null;const t=[];return{adverts:e.map((r,i)=>(t.push(i+1),{code:"",advertId:0,id:r,cpm:e.length-i})),pages:[{positions:t,page:1,count:e.length}]}},r._getfilteredPagedAdvGoods=function(e,t,r){const{filters:i,hasUncheckedFilters:n}=this._getFiltersFromQuery(t),{advData:o,advGoods:a}=e;if(n)return[];const s=[],d=[];return r=this._getDeliveryTime(r),a.forEach(e=>{if(!this._checkingProductWithFilters(e,i))return;e.isAdv=!0;const t=o.adverts.find(t=>t.id===e.nmId);t.fixed?(this._fillStatInfo(e,t,t.fixed),s.push(e)):this._checkingProductByDeliveryTime(e,r)&&d.push(e)}),d.sort((e,t)=>this._nonFixedGoodsSorterFunc(o,e,t)),this._getPagedAdvGoods(e,s,d)},r._getFiltersFromQuery=function(e){var t,r;const i=null==e?void 0:null===(t=e.queryDictionary)||void 0===t?void 0:t.filters,n={xsubject:[],fbrand:[],fcolor:[],priceU:[]};let o=!1;if(!i)return{filters:n,hasUncheckedFilters:o};for(const e in i){var a;if(n.hasOwnProperty(e))n[e]=null===(a=i[e].split(";"))||void 0===a?void 0:a.map(e=>parseInt(e));else if(this.advertType!==ADVERT_TYPE.promo){o=!0;break}}return this.advertType===ADVERT_TYPE.search&&null!=e&&null!==(r=e.queryDictionary)&&void 0!==r&&r.ssubject&&n.xsubject.push(parseInt(e.queryDictionary.ssubject)),{filters:n,hasUncheckedFilters:o}},r._getDeliveryTime=function(e){if(!e)return null;const t=(new Date).getHours();let r=t+e,i=0;return r>=24&&(r-=24*(i=Math.floor(r/24))),0===i?r<9?e=8-t:r<20||(e=32-t):e=1===i&&r<9?8-t:r<20?19-t:43-t,e+=24*i},r._checkingProductWithFilters=function(e,t){if(t.xsubject.length>0&&!t.xsubject.includes(e.subjectId))return!1;if(t.fbrand.length>0&&!t.fbrand.includes(e.brandCod))return!1;if(t.fcolor.length>0){if(!e.colorCodes.some(e=>t.fcolor.includes(e)))return!1}if(t.priceU.length>0){const r=100*parseInt(e.priceWithCouponAndDiscount),i=t.priceU[0],n=t.priceU[1];if(r<i||r>n)return!1}return!0},r._fillStatInfo=function(e,t,r,i=1){e.advStatFields={advertId:t.advertId,position:r,cpm:t.cpm,subjectId:e.subjectId,brandId:e.brandCod,kindId:e.kindId,page:i,identifier:this._getIdentifier()},e.extraAnaliticsCode=this.advertType===ADVERT_TYPE.catalog?"CAB":"SAB"},r._getIdentifier=function(){return this.queryDictionary.menuId?this.queryDictionary.menuId:this.queryDictionary.searchtext?this.queryDictionary.searchtext:this.queryDictionary.promoId?this.queryDictionary.promoId:""},r._checkingProductByDeliveryTime=function(e,t){return!!e.deliveryHours&&(!t||e.deliveryHours<=t+12)},r._getPagedAdvGoods=function(e,t,r){const{advData:i}=e;i.pages.sort((e,t)=>e.page-t.page);const n={};return i.pages.forEach(e=>{let o=r.splice(0,e.positions.length);o.forEach((t,r)=>{const n=i.adverts.find(e=>e.id===t.nmId);this._fillStatInfo(t,n,e.positions[r],e.page)}),this._recalcCpmForStat(o,i.minCPM),1===e.page&&(o=t.concat(o)),o.sort((e,t)=>e.advStatFields.position-t.advStatFields.position),n[e.page]=o}),n},r._recalcCpmForStat=function(e,t){if(!t)return;let r=new Map;for(let i=e.length-1;i>=0;i--){const n=e[i].advStatFields,o=n.subjectId,a=n.cpm;r.has(o)||r.set(o,{cpm:t}),n.cpm=r.get(o).cpm,r.get(o).cpm=a}},r._nonFixedGoodsSorterFunc=function(e,t,r){var i,n,o,a;const s=e.adverts.find(e=>e.id===t.nmId),d=e.adverts.find(e=>e.id===r.nmId),c=(null!==(i=null===(n=e.prioritySubjects)||void 0===n?void 0:n.indexOf(s.subject))&&void 0!==i?i:0)-(null!==(o=null===(a=e.prioritySubjects)||void 0===a?void 0:a.indexOf(d.subject))&&void 0!==o?o:0);return 0===c?d.cpm-s.cpm:c},r._mergeAdvertAndCommonGoods=function(e,t){if(!(null!=t&&t.length)>0)return e;let r=e,i=e.map(e=>e.nmId),n=t.map(e=>e.nmId);const o=i.getIntesection(n);return o.length>0&&(r=e.filter(e=>!o.includes(e.nmId))),t.forEach(t=>{const i=t.advStatFields.position;0===i||(i-1<e.length?r.splice(i-1,0,t):i>=e.length&&r.push(t))}),r},r._getCacheKey=function(e){switch(this.advertType){case ADVERT_TYPE.catalog:return`catalog-${e.menuId}`;case ADVERT_TYPE.search:return`search-${e.searchtext}`;case ADVERT_TYPE.promo:return`promo-${e.promoId}`;default:return null}},_createClass(t,[{key:"advertEnabled",get:function(){var e,t;return null===(e=wb.global.settings)||void 0===e?void 0:null===(t=e.switches)||void 0===t?void 0:t.enableCatalogAdvert}},{key:"advertType",get:function(){return null==this._advertType&&(this._advertType=this._getAdvertType(this.queryDictionary)),this._advertType}}]),t}(WbSpaModel);module.exports=XCatalogAdvertProvider;

},{"./helpers/catalogAdvertCache":5}],3:[function(require,module,exports){
"use strict";function _inheritsLoose(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t})(t,e)}let XCatalogFiltresProvider=function(t){function e(e){var r;return(r=t.call(this)||this).xData=e,r.abortController=null,r}_inheritsLoose(e,t);var r=e.prototype;return r.update=function(t){this.abort(),this.xData=t,this.abortController=null},r.loadFiltersAsync=async function(t){this.abort();const e=await this.$getCurrentXInfoAsync(),{xData:r}=this;this.abortController=new AbortController;let o=r.dataUrlFilters,a=e;r.xcatalogQuery&&"Search"!==r.catalogType&&(a+="&"+r.xcatalogQuery),"Search"===r.catalogType&&(a+=`&query=${encodeURIComponent(r.userSearch)}&resultset=filters&suppressSpellcheck=${!!r.nocorrection}`,r.ssubject&&(a+=`&subject=${r.ssubject}`));const l=decodeURIComponent(t);l&&(a+="&"+l),o+="?"+(a=wb.helpers.replaceDeliveryFilterVal(a)).split("&").sort().join("&");const s=await this.$httpClient.fetchBasicJSON(o,{signal:this.abortController.signal},{throwAbortError:!0});return null==s?void 0:s.data},r.getSpecificFilter=async function(t,e){const r=await this.$getCurrentXInfoAsync(),{xData:o}=this;let a=o.dataUrlFilters;return a+=`?filters=${e.replace(/ftop/,"f")}`,o.xcatalogQuery&&"Search"!==o.catalogType&&(a+="&"+o.xcatalogQuery),"Search"===o.catalogType&&(a+=`&query=${encodeURIComponent(o.userSearch)}&resultset=filters&suppressSpellcheck=${!!o.nocorrection}`),a+="&"+r,t&&(a+="&"+t),a=wb.helpers.replaceDeliveryFilterVal(a),(await this.$httpClient.fetchBasicJSON(a)).data},r.abort=function(){var t;null===(t=this.abortController)||void 0===t||t.abort()},e}(WbSpaModel);module.exports=XCatalogFiltresProvider;

},{}],4:[function(require,module,exports){
"use strict";function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _inheritsLoose(t,o){t.prototype=Object.create(o.prototype),t.prototype.constructor=t,_setPrototypeOf(t,o)}function _setPrototypeOf(t,o){return(_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,o){return t.__proto__=o,t})(t,o)}let XCatalogGoodsProvider=function(t){function o(o){var e;return(e=t.call(this)||this).xData=o,e.abortController=null,e.loadGoodsAsync=e.loadGoodsAsync.bind(_assertThisInitialized(e)),e}_inheritsLoose(o,t);var e=o.prototype;return e.update=function(t){this.abort(),this.xData=t,this.abortController=null},e.loadGoodsAsync=async function(t){var o,e,r,a;this.abort();const{xData:n}=this;this.abortController=new AbortController;const s=this.abortController,l=await this.$getCurrentXInfoAsync();let i=n.dataUrl,c=l;n.xcatalogQuery&&"Search"!==n.catalogType&&(c+=`&${n.xcatalogQuery}`),"Search"===n.catalogType&&(c+=`&query=${encodeURIComponent(n.userSearch)}&resultset=catalog&suppressSpellcheck=${!!n.nocorrection}`,n.ssubject&&(c+=`&subject=${n.ssubject}`));const u=decodeURIComponent(t);u&&(c+="&"+u),i+=`?${(c=wb.helpers.replaceDeliveryFilterVal(c)).split("&").sort().join("&")}`;const d=await this.$httpClient.fetchBasicJSON(i,{signal:s.signal},{retry:2,throwAbortError:!0,saveToBlob:"catalog"}),p=null==d?void 0:null===(o=d.params)||void 0===o?void 0:null===(e=o.curr)||void 0===e?void 0:e.toUpperCase();return{goods:null!==(r=null==d?void 0:null===(a=d.data)||void 0===a?void 0:a.products.map(t=>(t.currency=p,wb.xnm.convertXProductToSpaCatalogProduct(t))))&&void 0!==r?r:[],resp:d}},e.loadSubjectsAsync=function(t){const{xData:o}=this;let e=o.dataUrlOneFilter,r="filters=xsubject&"+t;return o.xcatalogQuery&&"Search"!==o.catalogType&&(r+=`&${o.xcatalogQuery}`),"Search"===o.catalogType&&(r+=`&query=${encodeURIComponent(o.userSearch)}&resultset=filters`),e+=`?${r.split("&").sort().join("&")}`,this.$httpClient.fetchBasicJSON(e,{},{retry:2})},e.abort=function(){var t;null===(t=this.abortController)||void 0===t||t.abort()},o}(WbSpaModel);module.exports=XCatalogGoodsProvider;

},{}],5:[function(require,module,exports){
"use strict";function _inheritsLoose(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t})(t,e)}let instance=null;const DATABASE_NAME="wb_catalog_adverts",ADVERTS_INFO_STORAGE_NAME="adverts_info",DATABASE_VERSION=1,CAHCE_DURATION=3e5;let CatalogAdvertCache=function(t){function e(){var e;return(e=t.call(this)||this)._startInterval(),e._bindEvents(),e}_inheritsLoose(e,t);var o=e.prototype;return o.saveAdvertInfo=async function(t,e){if(null==t)return;const o=await this._openDb();if(o)try{const n=o.transaction(["adverts_info"],"readwrite").objectStore("adverts_info"),a=WbSpaModel.prototype.$user.getCurrency();n.put({id:t,model:e,ttl:Date.now()+3e5,currency:a})}catch(e){var r;wb.spa.logError(e,`[CatalogAdvertCache]: failed to store advert item to idb key=${t}, storage_exists=${null===(r=o.objectStoreNames)||void 0===r?void 0:r.contains("adverts_info")}`)}},o.getAdvertInfo=async function(t){if(null==t)return null;const e=await this._openDb();if(!e)return null;try{const r=await this.$storageHelper.getItem(e,"adverts_info",t),n=WbSpaModel.prototype.$user.getCurrency();if((null==r?void 0:r.ttl)>=Date.now()&&(null==r?void 0:r.currency)==n)return window._debug&&console.log("adv info from cache"),r.model}catch(r){var o;wb.spa.logError(r,`[CatalogAdvertCache]: failed to get advert item key=${t}, storage_exists=${null===(o=e.objectStoreNames)||void 0===o?void 0:o.contains("adverts_info")}`)}return null},o._openDb=async function(){try{return await this.$storageHelper.openDb(DATABASE_NAME,{onupgradeneeded(t){if(t.objectStoreNames.contains("adverts_info"))return;t.createObjectStore("adverts_info",{keyPath:"id"}).createIndex("ttl","ttl",{unique:!1})},version:1})}catch(t){return wb.spa.logError(t,"[CatalogAdvertCache]: failed to open idb"),null}},o._startInterval=function(){setInterval(async()=>{try{const t=await this._openDb();if(!t)return;const e=t.transaction(["adverts_info"],"readwrite").objectStore("adverts_info");e.index("ttl").openCursor(IDBKeyRange.upperBound(Date.now())).onsuccess=(t=>{const o=t.target.result;o&&(e.delete(o.value.id),o.continue())})}catch(t){wb.spa.logError(t,"[CatalogAdvertCache]: failed to complete clear job")}},15e4)},o._bindEvents=function(){this.$eventBus.addEventListener("GeoUpdated",async()=>{try{const t=await this._openDb();if(!t)return;t.transaction(["adverts_info"],"readwrite").objectStore("adverts_info").clear()}catch(t){wb.spa.logError(t,"[CatalogAdvertCache]: failed to clear storage after geo update")}})},e}(WbSpaModel);module.exports=function(){function t(){}return t.getAdvertCache=function(){return null==instance&&(instance=new CatalogAdvertCache),instance},t}();

},{}]},{},[1]);
